(function(h){"use strict";class u{static addImageLink(e,i){return({media:t})=>{let n;if(typeof e=="string"?n=document.querySelector(e):n=e,!n)throw new Error("Element not found");const o=i==="source"?t.source_url:t.cache_url,r=n.selectionStart,c=n.value[r-1]&&!n.value[r-1].match(/\s/),b=typeof n.value[r]>"u"||!n.value[r].match(/\s/),S=`${c?" ":""}${o}${b?" ":""}`;n.value=n.value.substring(0,n.selectionStart)+S+n.value.substring(n.selectionStart),n.dispatchEvent(new Event("change")),n.dispatchEvent(new Event("input")),n.focus()}}static addSourceImageLink(e){return u.addImageLink(e,"source")}static addRisiBankImageLink(e){return u.addImageLink(e,"risibank")}static pasteImage(){return async({media:e})=>{const t=await(await fetch(e.cache_url)).blob();await navigator.clipboard.write([new ClipboardItem({[t.type]:t})]),document.execCommand("paste")}}}class l{}l.RISIBANK_URL="https://risibank.fr/",l.RISIBANK_CACHE_REGEX=/https:\/\/risibank.fr\/cache\/medias\/(\d+)\/(\d+)\/(\d+)\/(\d+)\/(\w+)\.(jpg|jpeg|gif|png)/;class d{static getPreferredModalOpenPosition(){const e={width:600,height:300},i=25;if(!document.activeElement)return d.adjustPositionForWindowBounds({x:window.innerWidth/2-e.width/2,y:window.innerHeight/2-e.height/2},e,i);const t=document.activeElement.getBoundingClientRect();return t.bottom+i+e.height>window.innerHeight?d.adjustPositionForWindowBounds({x:t.left,y:t.top-e.height-i},e,i):d.adjustPositionForWindowBounds({x:t.left,y:t.bottom+i},e,i)}static adjustPositionForWindowBounds({x:e,y:i},{width:t,height:n},o){const r=window.innerWidth,c=window.innerHeight;return e+t+o>r&&(e=r-t-o),e<o&&(e=o),i+n+o>c&&(i=c-n-o),i<o&&(i=o),{x:e,y:i}}}const w={defaultTab:"top",showNSFW:!1,allowUsernameSelection:!0,showCopyButton:!1,onCopyMedia:void 0,onSelectMedia:void 0},g={Light:{theme:"light"},Dark:{theme:"dark"},LightClassic:{theme:"light-old"},DarkClassic:{theme:"dark-old"}},m=f=>Object.entries(g).reduce((e,[i,t])=>(e[i]={...w,...t,...f},e),{});class p{static get Frame(){return m({container:void 0,type:"iframe",mediaSize:"md",navbarSize:"md"})}static get Modal(){return m({openPosition:d.getPreferredModalOpenPosition(),type:"modal",mediaSize:"md",navbarSize:"lg"})}static get Overlay(){return m({type:"overlay",mediaSize:"lg",navbarSize:"lg"})}}const s=class a{static init(){if(typeof localStorage<"u"){const e=localStorage.getItem("risibank-userscript-selected-username");typeof e=="string"&&e.match(/^[a-zA-Z0-9\][_-]+$/i)&&a.setSelectedUsername(e)}typeof window<"u"&&window.addEventListener("message",a.onIFrameMessage.bind(this),!1)}static setSelectedUsername(e){if(e===null||typeof e!="string"){a.selectedUsername=null,typeof localStorage<"u"&&localStorage.removeItem("risibank-userscript-selected-username");return}a.selectedUsername=e,typeof localStorage<"u"&&localStorage.setItem("risibank-userscript-selected-username",e)}static activate(e){if(e.type=e.type||"iframe",!["iframe","overlay","modal"].includes(e.type))throw new Error("Invalid type");if(e.theme=e.theme||"light",!["light","dark","light-old","dark-old"].includes(e.theme))throw new Error("Unsupported theme");if(e.mediaSize=e.mediaSize||"md",!["sm","md","lg"].includes(e.mediaSize))throw new Error("Unsupported media size. Allowed sizes are sm, md and lg");if(e.navbarSize=e.navbarSize||"md",!["sm","md","lg"].includes(e.navbarSize))throw new Error("Unsupported navbar size. Allowed sizes are sm, md and lg");if(e.defaultTab=e.defaultTab||"top",!["search","fav","hot","top","new","rand"].includes(e.defaultTab))throw new Error("Unsupported default tab. Allowed values are search, fav, hot, top, new and rand");if(e.showNSFW=typeof e.showNSFW=="boolean"?e.showNSFW:!0,e.allowUsernameSelection=typeof e.allowUsernameSelection=="boolean"?e.allowUsernameSelection:!0,e.showCopyButton=typeof e.showCopyButton=="boolean"?e.showCopyButton:!1,typeof e.onSelectMedia!="function")throw new Error("A callback must be specified for when a media is selected");if(e.type==="iframe"){if(++a._currentIntegrationId,typeof e.container>"u")throw new Error("A container must be specified when type is iframe");const t=typeof e.container=="string"?document.querySelector(e.container):e.container;if(!t)throw new Error("Invalid container specified");a.populateContainerWithIFrame(e,t,a._currentIntegrationId),a._integrations[a._currentIntegrationId]=e}if(e.type==="overlay"){if(!a._overlayContainer){const t=document.createElement("div");t.id="risibank-overlay",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.zIndex="2000000001",t.style.opacity="0.9",t.style.backgroundColor="rgba(0,0,0,0.5)",document.body.appendChild(t),a._overlayContainer=t}a._overlayContainer.style.display="block",a.populateContainerWithIFrame(e,a._overlayContainer,0),a._integrations[0]=e}if(e.type==="modal"){if(typeof e.openPosition>"u")throw new Error("A position must be specified when type is modal");if(!a._modalContainer){const t=document.createElement("div");t.id="risibank-modal",t.style.position="fixed",t.style.width="600px",t.style.height="300px",t.style.zIndex="2000000000",t.style.opacity="1",document.body.appendChild(t),a._modalContainer=t}a._modalContainer.style.display="block",a._modalContainer.style.pointerEvents="all",a._modalContainer.style.left=e.openPosition.x+"px",a._modalContainer.style.top=e.openPosition.y+"px",a.populateContainerWithIFrame(e,a._modalContainer,1),a._integrations[1]=e}}static getEmbedUrl(e,i){let t=`${l.RISIBANK_URL}/embed?id=${i}`;return t+=`&theme=${e.theme}`,t+=`&allowUsernameSelection=${e.allowUsernameSelection}`,t+=`&showCopyButton=${e.showCopyButton}`,t+=`&mediaSize=${e.mediaSize}`,t+=`&navbarSize=${e.navbarSize}`,t+=`&defaultTab=${e.defaultTab}`,t+=`&showNSFW=${e.showNSFW}`,["overlay","modal"].includes(e.type)&&(t+="&showCloseButton=true"),e.allowUsernameSelection&&typeof a.selectedUsername=="string"&&(t+=`&username=${a.selectedUsername}`),t}static hashOptions(e){return JSON.stringify([e.theme,e.allowUsernameSelection,e.showCopyButton,e.mediaSize,e.navbarSize,e.defaultTab,e.type])}static populateContainerWithIFrame(e,i,t){const n=a.hashOptions(e),o=i.querySelector("iframe");if(o&&o.getAttribute("data-hash")===n){i.style.display="block";return}const r=document.createElement("iframe");r.src=a.getEmbedUrl(e,t),r.style.width="100%",r.style.height="100%",r.style.border="none",r.style.overflow="hidden",r.setAttribute("data-hash",n),i.innerHTML="",i.appendChild(r)}static onIFrameMessage(e){if(!e.data||!e.data.type||!e.data.type.match(/^risibank/))return;if(e.origin!==l.RISIBANK_URL){console.log("ignoring event due to origin mismatch",e);return}const i=e.data.id,t=e.data.type;if(t==="risibank-closed"){a.desactivate(i);return}if(t==="risibank-username-selected"){const n=e.data.username;a.setSelectedUsername(n);return}if(t==="risibank-username-cleared"){a.setSelectedUsername(null);return}if(t==="risibank-media-copy"){const n=a._integrations[i];n?.onCopyMedia&&n.onCopyMedia({id:i,type:t,media:e.data.media});return}if(t==="risibank-media-selected"){const n=a._integrations[i];n?.onSelectMedia&&n.onSelectMedia({id:i,type:t,media:e.data.media}),a._integrations[i]&&["overlay","modal"].includes(a._integrations[i].type)&&a.desactivate(i);return}}static desactivate(e){if(typeof e>"u"){for(const t in a._integrations)a.desactivate(parseInt(t,10));return}const i=a._integrations[e];i&&(i.type==="iframe"&&a.desactivateIFrame(i,e),i.type==="overlay"&&a.desactivateOverlay(),i.type==="modal"&&a.desactivateModal())}static desactivateIFrame(e,i){const t=typeof e.container=="string"?document.querySelector(e.container):e.container;t&&(t.innerHTML="",delete a._integrations[i])}static desactivateOverlay(){const e=document.querySelector("#risibank-overlay");e&&(e.style.display="none")}static desactivateModal(){const e=document.querySelector("#risibank-modal");e&&(e.style.display="none",e.style.pointerEvents="none")}};s.Actions=u,s.Constants=l,s.Defaults=p,s.UI=d,s._integrations={},s._overlayContainer=null,s._modalContainer=null,s._currentIntegrationId=2,s.selectedUsername=null;let y=s;y.init(),h.RisiBank=y})(this.window=this.window||{});
