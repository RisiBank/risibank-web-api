(function(){"use strict";class l{static addImageLink(e,i){return({media:t})=>{let a;if(typeof e=="string"?a=document.querySelector(e):a=e,!a)throw new Error("Element not found");const r=i==="source"?t.source_url:t.cache_url,n=a.selectionStart,d=a.value[n-1]&&!a.value[n-1].match(/\s/),g=typeof a.value[n]>"u"||!a.value[n].match(/\s/),w=`${d?" ":""}${r}${g?" ":""}`;a.value=a.value.substring(0,a.selectionStart)+w+a.value.substring(a.selectionStart),a.dispatchEvent(new Event("change")),a.dispatchEvent(new Event("input")),a.focus()}}static addSourceImageLink(e){return l.addImageLink(e,"source")}static addRisiBankImageLink(e){return l.addImageLink(e,"risibank")}static pasteImage(){return async({media:e})=>{const t=await(await fetch(e.cache_url)).blob();await navigator.clipboard.write([new ClipboardItem({[t.type]:t})]),document.execCommand("paste")}}}class o{}o.RISIBANK_URL="https://risibank.fr/",o.RISIBANK_CACHE_REGEX=/https:\/\/risibank.fr\/cache\/medias\/(\d+)\/(\d+)\/(\d+)\/(\d+)\/(\w+)\.(jpg|jpeg|gif|png)/;class s{static getPreferredModalOpenPosition(){const e={width:600,height:300},i=25;if(!document.activeElement)return s.adjustPositionForWindowBounds({x:window.innerWidth/2-e.width/2,y:window.innerHeight/2-e.height/2},e,i);const t=document.activeElement.getBoundingClientRect();return t.bottom+i+e.height>window.innerHeight?s.adjustPositionForWindowBounds({x:t.left,y:t.top-e.height-i},e,i):s.adjustPositionForWindowBounds({x:t.left,y:t.bottom+i},e,i)}static adjustPositionForWindowBounds({x:e,y:i},{width:t,height:a},r){const n=window.innerWidth,d=window.innerHeight;return e+t+r>n&&(e=n-t-r),e<r&&(e=r),i+a+r>d&&(i=d-a-r),i<r&&(i=r),{x:e,y:i}}}const h={defaultTab:"top",showNSFW:!1,allowUsernameSelection:!0,showCopyButton:!1,onCopyMedia:void 0,onSelectMedia:void 0},m={Light:{theme:"light"},Dark:{theme:"dark"},LightClassic:{theme:"light-old"},DarkClassic:{theme:"dark-old"}},u=c=>Object.entries(m).reduce((e,[i,t])=>(e[i]={...h,...t,...c},e),{});class f{static get Frame(){return u({container:void 0,type:"iframe",mediaSize:"md",navbarSize:"md"})}static get Modal(){return u({openPosition:s.getPreferredModalOpenPosition(),type:"modal",mediaSize:"md",navbarSize:"lg"})}static get Overlay(){return u({type:"overlay",mediaSize:"lg",navbarSize:"lg"})}}class y{constructor(){if(this._integrations={},this._overlayContainer=null,this._modalContainer=null,this._currentIntegrationId=2,this._selectedUsername=null,typeof localStorage<"u"){const e=localStorage.getItem("risibank-userscript-selected-username");typeof e=="string"&&e.match(/^[a-zA-Z0-9\][_-]+$/i)&&(this._selectedUsername=e)}addEventListener("message",this._onIFrameMessage.bind(this),!1)}get Defaults(){return f}get UI(){return s}get Actions(){return l}get Constants(){return o}activate(e){if(e.type=e.type||"iframe",!["iframe","overlay","modal"].includes(e.type))throw new Error("Invalid type");if(e.theme=e.theme||"light",!["light","dark","light-old","dark-old"].includes(e.theme))throw new Error("Unsupported theme");if(e.mediaSize=e.mediaSize||"md",!["sm","md","lg"].includes(e.mediaSize))throw new Error("Unsupported media size. Allowed sizes are sm, md and lg");if(e.navbarSize=e.navbarSize||"md",!["sm","md","lg"].includes(e.navbarSize))throw new Error("Unsupported navbar size. Allowed sizes are sm, md and lg");if(e.defaultTab=e.defaultTab||"top",!["search","fav","hot","top","new","rand"].includes(e.defaultTab))throw new Error("Unsupported default tab. Allowed values are search, fav, hot, top, new and rand");if(e.showNSFW=typeof e.showNSFW=="boolean"?e.showNSFW:!0,e.allowUsernameSelection=typeof e.allowUsernameSelection=="boolean"?e.allowUsernameSelection:!0,e.showCopyButton=typeof e.showCopyButton=="boolean"?e.showCopyButton:!1,typeof e.onSelectMedia!="function")throw new Error("A callback must be specified for when a media is selected");if(e.type==="iframe"){if(++this._currentIntegrationId,typeof e.container>"u")throw new Error("A container must be specified when type is iframe");const t=typeof e.container=="string"?document.querySelector(e.container):e.container;if(!t)throw new Error("Invalid container specified");this._populateContainerWithIFrame(e,t,this._currentIntegrationId),this._integrations[this._currentIntegrationId]=e}if(e.type==="overlay"){if(!this._overlayContainer){const t=document.createElement("div");t.id="risibank-overlay",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.zIndex="2000000001",t.style.opacity="0.9",t.style.backgroundColor="rgba(0,0,0,0.5)",document.body.appendChild(t),this._overlayContainer=t}this._overlayContainer.style.display="block",this._populateContainerWithIFrame(e,this._overlayContainer,0),this._integrations[0]=e}if(e.type==="modal"){if(typeof e.openPosition>"u")throw new Error("A position must be specified when type is modal");if(!this._modalContainer){const t=document.createElement("div");t.id="risibank-modal",t.style.position="fixed",t.style.width="600px",t.style.height="300px",t.style.zIndex="2000000000",t.style.opacity="1",document.body.appendChild(t),this._modalContainer=t}this._modalContainer.style.display="block",this._modalContainer.style.pointerEvents="all",this._modalContainer.style.left=e.openPosition.x+"px",this._modalContainer.style.top=e.openPosition.y+"px",this._populateContainerWithIFrame(e,this._modalContainer,1),this._integrations[1]=e}}_getEmbedUrl(e,i){let t=`${o.RISIBANK_URL}/embed?id=${i}`;return t+=`&theme=${e.theme}`,t+=`&allowUsernameSelection=${e.allowUsernameSelection}`,t+=`&showCopyButton=${e.showCopyButton}`,t+=`&mediaSize=${e.mediaSize}`,t+=`&navbarSize=${e.navbarSize}`,t+=`&defaultTab=${e.defaultTab}`,t+=`&showNSFW=${e.showNSFW}`,["overlay","modal"].includes(e.type)&&(t+="&showCloseButton=true"),e.allowUsernameSelection&&typeof this.selectedUsername=="string"&&(t+=`&username=${this.selectedUsername}`),t}_hashOptions(e){return JSON.stringify([e.theme,e.allowUsernameSelection,e.showCopyButton,e.mediaSize,e.navbarSize,e.defaultTab,e.type])}_populateContainerWithIFrame(e,i,t){const a=this._hashOptions(e),r=i.querySelector("iframe");if(r&&r.getAttribute("data-hash")===a){i.style.display="block";return}const n=document.createElement("iframe");n.src=this._getEmbedUrl(e,t),n.style.width="100%",n.style.height="100%",n.style.border="none",n.style.overflow="hidden",n.setAttribute("data-hash",a),i.innerHTML="",i.appendChild(n)}_onIFrameMessage(e){if(!e.data||!e.data.type||!e.data.type.match(/^risibank/))return;if(e.origin!==o.RISIBANK_URL){console.log("ignoring event due to origin mismatch",e);return}const i=e.data.id,t=e.data.type;if(t==="risibank-closed"){this.desactivate(i);return}if(t==="risibank-username-selected"){const a=e.data.username;this.selectedUsername=a;return}if(t==="risibank-username-cleared"){this.selectedUsername=null;return}if(t==="risibank-media-copy"){const a=this._integrations[i];a?.onCopyMedia&&a.onCopyMedia({id:i,type:t,media:e.data.media});return}if(t==="risibank-media-selected"){const a=this._integrations[i];a?.onSelectMedia&&a.onSelectMedia({id:i,type:t,media:e.data.media}),this._integrations[i]&&["overlay","modal"].includes(this._integrations[i].type)&&this.desactivate(i);return}}desactivate(e){if(typeof e>"u"){for(const t in this._integrations)this.desactivate(parseInt(t,10));return}const i=this._integrations[e];i&&(i.type==="iframe"&&this._desactivateIFrame(i,e),i.type==="overlay"&&this._desactivateOverlay(),i.type==="modal"&&this._desactivateModal())}_desactivateIFrame(e,i){const t=typeof e.container=="string"?document.querySelector(e.container):e.container;t&&(t.innerHTML="",delete this._integrations[i])}_desactivateOverlay(){const e=document.querySelector("#risibank-overlay");e&&(e.style.display="none")}_desactivateModal(){const e=document.querySelector("#risibank-modal");e&&(e.style.display="none",e.style.pointerEvents="none")}get selectedUsername(){return this._selectedUsername}set selectedUsername(e){if(e===null||typeof e!="string"){this._selectedUsername=null,typeof localStorage<"u"&&localStorage.removeItem("risibank-userscript-selected-username");return}this._selectedUsername=e,typeof localStorage<"u"&&localStorage.setItem("risibank-userscript-selected-username",e)}}typeof window<"u"&&(window.RisiBank=new y)})();
